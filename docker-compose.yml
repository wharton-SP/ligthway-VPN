version: "3.8"

services:
  # --- WireGuard VPN Server ---
  wireguard:
    image: ghcr.io/linuxserver/wireguard
    container_name: wireguard
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    network_mode: "host"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Africa/Nairobi
      - SERVERURL=192.168.8.10
      - SERVERPORT=51820
      - PEERS=client1
      - PEERSDNS=off
      - INTERNAL_SUBNET=192.0.0.0
      - ALLOWEDIPS=0.0.0.0/0
    volumes:
      - ./wireguard-config:/config
      - /lib/modules:/lib/modules:ro
    restart: unless-stopped

  # --- Backend Flask ---
  backend:
    build: ./backend
    container_name: vpn-backend
    environment:
      - FLASK_APP=app.py
      - FLASK_ENV=development
    volumes:
      - ./backend:/app
      - ./wireguard-config:/wireguard-config
    ports:
      - "5000:5000"
    depends_on:
      - wireguard
    restart: unless-stopped

  # --- Frontend React/Vite ---
  frontend:
    build: ./frontend
    container_name: vpn-frontend
    command: npm run dev -- --host
    volumes:
      - ./frontend:/app
      - /app/node_modules 
    ports:
      - "5173:5173"
    depends_on:
      - backend
    environment:
      - CHOKIDAR_USEPOLLING=true
    restart: unless-stopped
